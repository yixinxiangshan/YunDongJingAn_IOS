// Generated by CoffeeScript 1.9.1
(function() {
  var ECpageClass;

  ECpageClass = (function() {
    var root;

    root = {};

    ECpageClass.prototype._page_name = "";

    ECpageClass.prototype._item_info = {};

    ECpageClass.prototype._platform = "";

    ECpageClass.prototype._listview_data = {
      pullable: false,
      hasFooterDivider: true,
      hasHeaderDivider: true,
      dividerHeight: 0,
      dividerColor: "#EBEBEB",
      data: [
        {
          viewType: "ListViewCellGroupTitle",
          textTitle: "手机号验证"
        }, {
          viewType: "ListViewCellInputTextWithButton",
          inputType: "phone",
          inputText: "",
          hint: "手机号",
          btnName: "验证",
          name: "phone"
        }, {
          viewType: "ListViewCellInputText",
          inputType: "number",
          hint: "验证码",
          type: "captcha",
          inputText: "",
          name: "code"
        }, {
          viewType: "ListViewCellButton",
          btnTitle: "使 用",
          btnType: "ok"
        }
      ]
    };

    ECpageClass.prototype._constructor = function(_page_name1) {
      this._page_name = _page_name1;
      root = this;
      this.prepareForInitView();
      $A().page().widget(this._page_name + "_ListViewBase_0").data(JSON.stringify(this._listview_data));
      $A().page().widget(this._page_name + "_ListViewBase_0").onItemInnerClick(function(data) {
        return root.onItemInnerClick(data);
      });
      $A().page().widget(this._page_name + "_ListViewBase_0").onItemClick(function(data) {
        return root.onItemClick(data);
      });
      return $A().page().onCreated(function() {
        return root.onCreated();
      });
    };

    function ECpageClass(_page_name) {
      this._constructor(_page_name);
    }

    ECpageClass.prototype.onCreated = function() {
      if ((root._platform != null) && root._platform === "ios") {
        return $A().page().widget(this._page_name + "_ListViewBase_0").refreshData(JSON.stringify(this._listview_data));
      }
    };

    ECpageClass.prototype.onItemClick = function(data) {};

    ECpageClass.prototype.onItemInnerClick = function(data) {
      var code, phone;
      $A().app().log(JSON.stringify(data));
      phone = data._form.phone != null ? data._form.phone : "";
      code = data._form.code != null ? data._form.code : "";
      if (parseInt(data.position) === 1) {
        if (parseInt(phone.length) === 11) {
          $A().app().callApi({
            method: "user/get_regcode",
            mobile: "" + phone,
            cacheTime: 0
          });
          $A().app().makeToast("正在获取验证码");
        } else {
          $A().app().makeToast("请输入正确的手机号");
        }
      }
      if (parseInt(data.position) === 3) {
        if ((code != null) && code !== "" && code.length === 6) {
          $A().app().makeToast("验证中……");
          return $A().app().callApi({
            method: "user/login_bycode",
            mobile: "" + phone,
            code: "" + code,
            cacheTime: 0
          }).then(function(res) {
            if (res.success) {
              $A().app().makeToast("登录成功");
              $A().page("page_my").param({
                key: "_setting_changed",
                value: "true"
              });
              $A().page("page_home").param({
                key: "_setting_changed",
                value: "true"
              });
              $A().lrucache().set({
                key: "phone",
                value: "" + phone
              });
              return $A().page().setTimeout("1000").then(function() {
                return $A().app().closePage();
              });
            } else {
              return $A().app().makeToast("登录失败");
            }
          });
        } else {
          return $A().app().makeToast("请输入正确的验证码");
        }
      }
    };

    ECpageClass.prototype.onResume = function() {};

    ECpageClass.prototype.prepareForInitView = function() {
      return $A().app().platform().then(function(platform) {
        return root._platform = platform;
      });
    };

    return ECpageClass;

  })();

  new ECpageClass("page_login");

}).call(this);
